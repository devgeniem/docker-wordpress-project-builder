#!/usr/bin/env bash
##
# Phinx wrapper
# You need to install phinx through composer first
##

##
# Export phinx envs in DEV and CI
##
if [ ! -z "$DB_HOST" ]; then
  export PHINX_DBHOST=$DB_HOST
elif [ ! -z "$DB_PORT_3306_TCP_ADDR" ]; then
  export PHINX_DBHOST=$DB_PORT_3306_TCP_ADDR
else
  echo "ERROR: You need to set DB_HOST!"
  return 1
fi

if [ ! -z "$DB_PORT" ]; then
  export PHINX_DBPORT=$DB_PORT
else
  export PHINX_DBPORT="3306"
fi

if [ ! -z "$DB_NAME" ]; then
  export PHINX_DBNAME=$DB_NAME
elif [ ! -z "$DB_ENV_MYSQL_DATABASE" ]; then
  export PHINX_DBNAME=$DB_ENV_MYSQL_DATABASE
elif [ ! -z "$WEB_ENV_DB_NAME" ]; then
  export PHINX_DBNAME=$WEB_ENV_DB_NAME
fi

if [ ! -z "$DB_USER" ]; then
  export PHINX_DBUSER=$DB_USER
elif [ ! -z "$DB_ENV_MYSQL_USER" ]; then
  export PHINX_DBUSER=$DB_ENV_MYSQL_USER
elif [ ! -z "$WEB_ENV_DB_USER" ]; then
  export PHINX_DBUSER=$WEB_ENV_DB_USER
fi

if [ ! -z "$DB_PASSWORD" ]; then
  export PHINX_DBPASSWORD=$DB_PASSWORD
elif [ ! -z "$DB_ENV_MYSQL_PASSWORD" ]; then
  export PHINX_DBPASSWORD=$DB_ENV_MYSQL_PASSWORD
elif [ ! -z "$WEB_ENV_DB_PASSWORD" ]; then
  export PHINX_DBPASSWORD=$WEB_ENV_DB_PASSWORD
fi

if [ ! -z "$WP_ENV" ]; then
  export PHINX_ENVIRONMENT=$WP_ENV
elif [ ! -z "$WEB_ENV_WP_ENV" ]; then
  export PHINX_ENVIRONMENT=$WEB_ENV_WP_ENV
else
  export PHINX_DBPORT="testing"
fi

# Run phinx
php $PROJECT_ROOT/vendor/bin/phinx $@
